# tasks/config/main.yml
---
- name: Check existing configuration
  ansible.builtin.stat:
    path: "{{ teleport_config_path }}"
  register: teleport_config_status
  tags: [configuration]

- name: Manage Teleport configuration lifecycle
  block:
    - name: Backup existing configuration
      ansible.builtin.copy:
        src: "{{ teleport_config_path }}"
        dest: "{{ teleport_config_path }}.bak"
        remote_src: true
        mode: "0600"
      when:
        - teleport_backup_config | bool
        - teleport_config_status.stat.exists
      tags: [configuration]

    - name: Apply new configuration template
      ansible.builtin.template:
        src: "{{ teleport_config_template }}"
        dest: "{{ teleport_config_path }}"
        owner: "root"
        group: "root"
        mode: "0600"
        validate: "teleport validate --config %s"
      notify: Reload Teleport service
      tags: [configuration]

  rescue:
    - name: Handle configuration errors
      ansible.builtin.fail:
        msg: "Configuration management failed. Manual intervention required."
      tags: [configuration]


- name: Verify configuration syntax
  ansible.builtin.command:
    cmd: "teleport validate --config {{ teleport_config_path }}"
  changed_when: false
  tags: [configuration, validation]
